function doArithmetic(){var e=Number(document.getElementById("a").value),t=Number(document.getElementById("d").value);seqLen=maxSeqLen,seq[0]=Big(e);for(var n=1;seqLen>n;n++)seq[n]=seq[n-1].plus(t);displaySequence(),algorithm="Arithmetic progression",parameters=[["a",e],["d",t]]}function doFactorial(){seqLen=maxSeqLen,seq[0]=Big(1);for(var e=1;seqLen>e;e++)seq[e]=seq[e-1].times(e);displaySequence(),algorithm="Factorial",parameters=[]}function doTriangle(){seqLen=maxSeqLen,seq[0]=Big(1);for(var e=1;seqLen>e;e++)seq[e]=seq[e-1].plus(e+1);displaySequence(),algorithm="Triangular",parameters=[]}function doFibonacci(){seqLen=maxSeqLen;var e=Number(document.getElementById("n0").value),t=Number(document.getElementById("n1").value),n=Number(document.getElementById("k").value);1>n?(n=1,document.getElementById("k").value=1):n>99&&(n=99,document.getElementById("k").value=99),seq[0]=Big(e),seq[1]=Big(t);for(var o=2;seqLen>o;o++)seq[o]=seq[o-1].times(n).plus(seq[o-2]);displaySequence(),algorithm="Fibonacci",parameters=[["n0",e],["n1",t],["k",n]]}function doTribonacci(){seqLen=maxSeqLen;var e=Number(document.getElementById("t0").value),t=Number(document.getElementById("t1").value),n=Number(document.getElementById("t2").value);seq[0]=Big(e),seq[1]=Big(t),seq[2]=Big(n);for(var o=3;seqLen>o;o++)seq[o]=seq[o-1].plus(seq[o-2]).plus(seq[o-3]);displaySequence(),algorithm="Tribonacci",parameters=[["n0",e],["n1",t],["n2",n]]}function doPowers(){seqLen=maxSeqLen;var e=Number(document.getElementById("base").value);2>e?(e=2,document.getElementById("base").value=2):e>99&&(e=99,document.getElementById("base").value=99),seq[0]=Big(1);for(var t=1;seqLen>t;t++)seq[t]=seq[t-1].times(e);displaySequence(),algorithm="Power",parameters=[["base",e]]}function doPrimes(e){(isNaN(e)||0>e)&&(e=0);for(var t=e?e:8*maxSeqLen,n=[],o=1;t>o;o++)n[o]=!0;for(var r=Math.sqrt(t),o=2;r>o;o++)if(n[o]===!0)for(var l=o*o;t>l;l+=o)n[l]=!1;for(var o=1,l=0;t>o&&maxSeqLen>l;)n[o]===!0&&(seq[l++]=Big(o)),o++;seqLen=l,displaySequence(),algorithm="Primes",parameters=[]}function doSin(){var e=Number(document.getElementById("amplitude").value),t=Number(document.getElementById("r").value)*Math.PI/180;seqLen=maxSeqLen;for(var n=0;seqLen>n;n++)seq[n]=Big(Math.round(e+e*Math.sin(t*n)));displaySequence(),e>63&&(document.getElementById("modulus").value=e+e+1),algorithm="Sin",parameters=[["a",e],["r",t]]}function doRandom(){var e=Number(document.getElementById("random").value);2>e?(e=2,document.getElementById("random").value=2):e>999&&(e=999,document.getElementById("random").value=999),seqLen=maxSeqLen;for(var t=0;seqLen>t;t++)seq[t]=Big(Math.floor(Math.random()*e));document.getElementById("modulus").value=e,displaySequence(),algorithm="Random",parameters=[["n",e]]}function doRandomWalk(){var e=Number(document.getElementById("random").value);2>e?(e=2,document.getElementById("random").value=2):e>999&&(e=999,document.getElementById("random").value=999),seqLen=maxSeqLen;var t=Math.floor(e/2);seq[0]=Big(t);var n;for(n=1;seqLen>n&&(t+=Math.random()<.5?-1:1,!(0>t||t==e));n++)seq[n]=Big(t);seqlen=n,document.getElementById("modulus").value=e,displaySequence(),algorithm="Random Walk",parameters=[["n",e]]}function doDiceWalk(){var e=Number(document.getElementById("random").value);2>e?(e=2,document.getElementById("random").value=2):e>999&&(e=999,document.getElementById("random").value=999);var t=Math.floor(e/2);seq[0]=Big(t);var n,o;for(seqLen=maxSeqLen,i=1;i<maxSeqLen;i++)n=Math.floor(6*Math.random())+1,o=Math.floor(6*Math.random())+1,t+=n-o,(0>t||t>=e)&&(seqLen=i,t=Math.floor(e/2)),seq[i]=Big(t);document.getElementById("modulus").value=e,displaySequence(),algorithm="Dice",parameters=[["n",e]]}function doPi(e){(isNaN(e)||1>e||e>maxSeqLen)&&(e=160),Big.DP=e,seqLen=e,x1=arctan(Big(1).div(5)),x2=arctan(Big(1).div(239)),pi=x1.times(4).minus(x2).times(4).toString(),seq[0]=Big(3);for(var t=1;seqLen>t;t++)seq[t]=Big(pi[t+1]);document.getElementById("modulus").value=10,displaySequence(),algorithm="Pi",parameters=[]}function arctan(e){for(var t=e,n=0,o=e.times(e),r=e,l=-1,a=3;!t.eq(n);a+=2)r=r.times(o),n=t,t=l>0?t.plus(r.div(a)):t.minus(r.div(a)),l=-l;return t}function doPhi(e){(isNaN(e)||1>e||e>maxSeqLen)&&(e=200),Big.DP=e,seqLen=e,phi=Big(5).sqrt().add(1).div(2).toString(),seq[0]=Big(1);for(var t=1;seqLen>t;t++)seq[t]=Big(phi[t+1]);document.getElementById("modulus").value=10,displaySequence(),algorithm="Golden Ratio",parameters=[]}function doBernoullinumerators(e){(isNaN(e)||1>e||e>32)&&(e=24),seqLen=e;for(var t=0;seqLen>t;t++)seq[t]=Big(adaBernoulliNumber(t+1).numerator());displaySequence(),algorithm="Bernoulli Numerators",parameters=[]}function doBernoullidenominators(e){(isNaN(e)||1>e||e>32)&&(e=24),seqLen=e;for(var t=0;seqLen>t;t++)seq[t]=Big(adaBernoulliNumber(t+1).denominator());displaySequence(),algorithm="Bernoulli Denominators",parameters=[]}function setSeq(e){if(void 0==e)throw"No sequence provided in setSeq";if(e.length<2)throw"Sequence too short in setSeq:"+seq.length;var t;for(t=0;t<e.length&&maxSeqLen>t;t++)seq[t]=Big(e[t]);seqLen=t,displaySequence(),algorithm="Preset",parameters=[]}function displaySequence(e,t,n){if(isNaN(e)&&(e=100),isNaN(t)&&(t=1e3),isNaN(n)&&(n=120),0==e&&(e=seqLen),0!=seqLen){0==t&&(t=e*(n+40));for(var o=seq[0].toString(),r=1,l=Big(2).pow(64).minus(1),a=Big(10).pow(50).minus(1),i="",s=0,d=0;seqLen>r&&e>r&&o.length<t&&(i=seq[r].toString(),!(i.length>n));)seq[r].gt(a)?(o=o+', <span style="color:red">'+i+"</span>",d++):seq[r].gt(l)?(o=o+', <span style="color:blue">'+i+"</span>",s++):o=o+", "+i,r++;seqLen>r&&(o+=", ..."),document.getElementById("sequence").innerHTML=o;var m="";s&&(m+='<span style="color:blue">Blue numbers exceed 64 binary bits. </span>'),d&&(m+='<span style="color:red">Red numbers exceed 50 decimal digits. </span>'),document.getElementById("colourexplanation").innerHTML=m,document.getElementById("reducebutton").disabled=!1}}function doOEIS(e){if(isNaN(e)&&(e=10),1>e)throw"Search length too short to search OEIS: "+e;0!=seqLen&&window.open("https://oeis.org/search?q="+seq.slice(0,seqLen>e?e:seqLen).join("%2C+")+"&sort=&language=english&go=Search")}function doModsequence(){var e=Number(document.getElementById("modulus").value);2>e?(e=2,document.getElementById("modulus").value=e):e>128&&(e=128,document.getElementById("modulus").value=e),modulus=e;for(var t=0;seqLen>t;t++)modSeq[t]=(Number(seq[t].mod(modulus))+modulus)%modulus;displayModsequence(),primeFactors(modulus)}function primeFactors(e){for(var t,n=sieve(Math.sqrt(e)+1),o=[],r=0;r<n.length&&!(n[r]*n[r]>e);r++){for(t=0;e%n[r]==0;)t++,e=Math.floor(e/n[r]);t&&o.push([n[r],t])}if(e>1&&o.push([e,1]),1==o.length&&1==o[0][1])html="prime";else{html="";for(var r=0;r<o.length;r++)html&&(html+=" &times; "),html+=o[r][0],o[r][1]>1&&(html+="<sup>"+o[r][1]+"</sup>")}document.getElementById("primefactors").innerHTML=html}function sieve(e){for(var t=[],n=2;e>n;n++)t[n]=!0;for(var o=Math.sqrt(e),n=2;o>n;n++)if(t[n]===!0)for(var r=n*n;e>r;r+=n)t[r]=!1;for(var l=[],n=0;e>n;n++)t[n]&&l.push(n);return l}function doLogsequence(){for(var e,t=0,n=0;seqLen>n;n++)e=Number(seq[n]),0>=e?modSeq[n]=0:(modSeq[n]=Math.round(Math.log10(Number(seq[n]))),modSeq[n]>t&&(t=modSeq[n]));displayModsequence()}function displayModsequence(){document.getElementById("modsequence").value=modSeq.slice(0,seqLen).join(" "),displayPeriod(),document.getElementById("displaybutton").disabled=!1}function updateModseq(){var e=document.getElementById("modSequence").value.match(/\d+/g);return e.length<2?void window.alert("Sequence must contains at least two numbers"):e.length>maxSeqLen?void window.alert("Sequence cannot contain more than "+maxSeqLen+"numbers"):(modSeq=e,seqLen=e.length,modulus=0,void displayModsequence())}function displayPeriod(){document.getElementById("length").innerHTML=seqLen,document.getElementById("mod").innerHTML=modulus;for(var e=Math.floor(seqLen/2),t=1;e+1>t;t++)if(cmp(t,0,e))return void(document.getElementById("period").innerHTML=t);document.getElementById("period").innerHTML="unknown"}function cmp(e,t,n){return t==n?!0:modSeq[e]==modSeq[t]?cmp(e+1,t+1,n):!1}function displayCorrelation(e){isNaN(e)&&(e=0);for(var t=[],n=Math.floor(seqLen/2),o=Math.round(e*Math.log2(1.5)),r=Math.round(e*Math.log2(4/3)),l=1;n>l;l++){for(var a=0,i=0;n>i;i++)if(0==e)modSeq[l+i]==modSeq[i]&&a++;else if(1==e)modSeq[l+i]%7==modSeq[i]%7&&a++;else if(2==e)modSeq[l+i]%12==modSeq[i]%12&&a++;else{var s=Math.abs(modSeq[l+i]%e-modSeq[i]%e);(0==s||s==r||s==o)&&a++}t[l]=[l,a]}if(0!=t.length){t.sort(function(e,t){return t[1]==e[1]?e[0]-t[0]:t[1]-e[1]});for(var d=0;20>d&&t[d][1];)d++;t.splice(d,t.length-d),t.sort(function(e,t){return e[0]-t[0]});for(var m='<p><strong>autocorrelation table</strong></p><table class="table table-bordered"><tr>',l=0;d>l;l++)m=m+"<td>"+t[l][0]+"</td>";m+="</tr><tr>";for(var l=0;d>l;l++)t[l][1]==n?m+="<td><b>100%</b></td>":m=m+"<td>"+Math.round(1e3*t[l][1]/n)/10+"%</td>";m+="</tr></table>",document.getElementById("correlationtable").innerHTML=m}}function rollWidth(e){cellWidth+e>2&&32>cellWidth+e&&(cellWidth+=e),drawRoll()}function rollHeight(e){cellHeight+e>2&&32>cellHeight+e&&(cellHeight+=e),drawRoll()}function doLife(){for(var e,t,n,o,r=0,l=[],a=0;seqLen>a;a++)for(var i=0;nRows>i;i++)roll[a][i]>1&&(roll[a][i]=1);seloffset=0;for(var a=0;seqLen>a;a++){l[a]=[];for(var i=0;nRows>i;i++)e=0==a?seqLen-1:a-1,t=a==seqLen-1?0:a+1,n=0==i?nRows-1:i-1,o=i==nRows-1?0:i+1,r=roll[e][n]+roll[e][i]+roll[e][o]+roll[a][n]+roll[a][o]+roll[t][n]+roll[t][i]+roll[t][o],2>r?l[a][i]=0:2==r||3==r?l[a][i]=roll[a][i]:r>3&&(l[a][i]=0),3==r&&0==roll[a][i]&&(l[a][i]=1)}for(var a=0;seqLen>a;a++)for(var i=0;nRows>i;i++)roll[a][i]=l[a][i];drawRoll()}function doCat(){var e=[];if(!(nRows>seqLen)){for(var t=0;nRows>t;t++)e[t]=[];for(var t=0;nRows>t;t++)for(var n=0;nRows>n;n++)e[n%nRows][(t+n)%nRows]=roll[t][n];for(var t=0;nRows>t;t++)for(var n=0;nRows>n;n++)roll[t][n]=e[t][n];var o=Number(document.getElementById("pisano").innerHTML);o||(o=pisanoPeriod(nRows)),document.getElementById("pisano").innerHTML=1==o?"":o-1,drawRoll()}}function pisanoPeriod(e){if(void 0==e||1>e||e>128)throw"pisanoPeriod takes 1..128: "+e;return[1,3,8,6,20,24,16,12,24,60,10,24,28,48,40,24,36,24,18,60,16,30,48,24,100,84,72,48,14,120,30,48,40,36,80,24,76,18,56,60,40,48,88,30,120,48,32,24,112,300,72,84,108,72,20,48,72,42,58,120,60,30,48,96,140,120,136,36,48,240,70,24,148,228,200,18,80,168,78,120,216,120,168,48,180,264,56,60,44,120,112,48,120,96,180,48,196,336,120,300,50,72,208,84,80,108,72,72,108,60,152,48,76,72,240,42,168,174,144,120,110,60,40,30,500,48,256,192][e-1]}function mouseDown(e){var t=canvas.getBoundingClientRect();if(rect.startX=e.clientX-t.left,rect.startY=e.clientY-t.top,canvas.style.cursor="crosshair",mousedown=!0,!touchscreen){for(var n=0;seqLen>n;n++)for(var o=0;nRows>o;o++)roll[n][o]>1&&(roll[n][o]=e.shiftKey?3:1);seloffset=0}}function mouseMove(e){var t=canvas.getBoundingClientRect(),n=Math.floor((e.clientX-t.left)/cellWidth),o=Math.floor((e.clientY-t.top)/cellHeight);document.getElementById("notenumber").innerHTML=nRows-o-1,document.getElementById("notename").innerHTML=midiNoteName(midiNotes[nRows-o-1]),document.getElementById("noteindex").innerHTML=n,mousedown&&(rect.w=e.clientX-t.left-rect.startX,rect.h=e.clientY-t.top-rect.startY,drawRoll(),context.strokeStyle="Red",context.strokeRect(rect.startX,rect.startY,rect.w,rect.h),context.strokeStyle="LightGray")}function mouseUp(e){canvas.style.cursor="default",mousedown=!1;var t=canvas.getBoundingClientRect();if(e.clientX-t.left==rect.startX&&e.clientY-t.top==rect.startY){var n=Math.floor((e.clientX-t.left)/cellWidth),o=Math.floor((e.clientY-t.top)/cellHeight);roll[n][o]>1?roll[n][o]=1:1==roll[n][o]&&(roll[n][o]=2)}pushSelection(),writeMetadata(),outputNoteNames(),drawRoll()}function mouseOut(e){mousedown||(document.getElementById("notenumber").innerHTML="",document.getElementById("notename").innerHTML="",document.getElementById("noteindex").innerHTML="")}function keyDown(e){var t=e.which||e.keycode;return 65==t?selectAll():67==t?copySelection():86==t?pasteSelection():90==t?popSelection():188==t?nudgeSelection(-1):190==t?nudgeSelection(1):void 0}function initRoll(){canvas.addEventListener("mousedown",mouseDown,!1),canvas.addEventListener("mousemove",mouseMove,!1),canvas.addEventListener("mouseup",mouseUp,!1),canvas.addEventListener("mouseout",mouseOut,!1),window.addEventListener("keydown",keyDown,!1),touchscreen="ontouchstart"in window,nRows=0;for(var e=0;seqLen>e;e++)modSeq[e]>nRows&&modSeq[e]<128&&(nRows=modSeq[e]);nRows++;for(var e=0;seqLen>e;e++){roll[e]=[];for(var t=0;nRows>t;t++)roll[e][t]=0;roll[e][nRows-modSeq[e]-1]=1}rollempty=!1,document.getElementById("pisano").innerHTML="",initSelectionmemory(),drawRoll(),drawMap(),initAudio(),initExport()}function drawRoll(){if(rollempty)return initRoll();canvas.width=cellWidth*seqLen,canvas.height=cellHeight*nRows,context.clearRect(0,0,canvas.width,canvas.height),context.rect(0,0,canvas.width,canvas.height),context.strokeStyle="Blue",context.stroke(),selected=0,selright=0,selleft=seqLen,seltop=0,selbot=nRows;for(var e=0;seqLen>e;e++)for(var t=0;nRows>t;t++)context.beginPath(),context.rect(e*cellWidth,t*cellHeight,cellWidth,cellHeight),!mousedown||1!=roll[e][t]&&2!=roll[e][t]||(rect.w>0?(rect.topleftX=rect.startX,rect.borightX=rect.startX+rect.w):(rect.topleftX=rect.startX+rect.w,rect.borightX=rect.startX),rect.h>0?(rect.topleftY=rect.startY,rect.borightY=rect.startY+rect.h):(rect.topleftY=rect.startY+rect.h,rect.borightY=rect.startY),e*cellWidth>rect.topleftX-cellWidth&&(e+1)*cellWidth<rect.borightX+cellWidth&&t*cellHeight>rect.topleftY-cellHeight&&(t+1)*cellHeight<rect.borightY+cellHeight?roll[e][t]=2:roll[e][t]=1),1==roll[e][t]?(context.fillStyle="CadetBlue",context.fill()):roll[e][t]>1?(context.fillStyle="Red",context.fill(),selected++,e>selright&&(selright=e),selleft>e&&(selleft=e),t>seltop&&(seltop=t),selbot>t&&(selbot=t)):seloffset&&e+seloffset>=0&&seqLen>e+seloffset&&memory[e+seloffset][t]?(context.strokeStyle="Red",context.stroke()):(context.strokeStyle="LightGray",context.stroke());document.getElementById("selected").innerHTML=selected?selected:""}function selectAll(){for(var e=0;seqLen>e;e++)for(var t=0;nRows>t;t++)roll[e][t]>=1&&(roll[e][t]=2);drawRoll()}function pushSelection(){for(var e="",t="",n=0;seqLen>n;n++){t="";for(var o=0;nRows>o;o++)roll[n][o]>1&&(t+=","+o);t.length&&(e.length?e+=" "+n+t:e=n+t)}e.length&&e!=selStack[selStack.length-1]&&(selStack.push(e),document.getElementById("selection").value=e),displayContour()}function displayContour(){for(var e=[],t=0;seqLen>t&&e.length<12;t++)for(var n=0;nRows>n;n++)if(roll[t][n]>1){e.push(n);break}if(e){for(var o="",r=e[0],t=1;t<e.length;t++)o+=e[t]>r?"D":e[t]<r?"U":"R",r=e[t];document.getElementById("contour").innerHTML=o}}function popSelection(){for(var e=[],t=[],n=0;seqLen>n;n++)for(var o=0;nRows>o;o++)roll[n][o]>1&&(roll[n][o]=1);if(selStack.length>1&&(selStack.pop(),selStack.length>0)){e=selStack[selStack.length-1].split(" ");for(var n=0;n<e.length;n++){t=e[n].split(",");for(var o=1;o<t.length;o++)roll[t[0]][t[o]]=2}}document.getElementById("selection").value=selStack.length?selStack[selStack.length-1]:"",drawRoll()}function clearSelectionmemory(){for(var e=0;seqLen>e;e++)for(var t=0;nRows>t;t++)memory[e][t]=0;seloffset=0}function copySelection(){for(var e=0;seqLen>e;e++)for(var t=0;nRows>t;t++)memory[e][t]=roll[e][t]>1?1:0;seloffset=0}function nudgeSelection(e){if(isNaN(e))throw"Nudge requires numeric argument";seloffset-=e,-seqLen>=seloffset?seloffset=-seqLen+1:seloffset>=seqLen&&(seloffset=seqLen-1),drawRoll()}function pasteSelection(){for(var e=seloffset>0?0:-seloffset,t=seloffset>0?seqLen-seloffset:seqLen,n=e;t>n;n++)for(var o=0;nRows>o;o++)1==memory[n+seloffset][o]&&(roll[n][o]=3);pushSelection(),drawRoll()}function initSelectionmemory(){for(var e=0;seqLen>e;e++){memory[e]=[];for(var t=0;nRows>t;t++)memory[e][t]=0}seloffset=0}function setPitch(e){if(0>e||e>11)throw"Pitch out of range (0-11):"+e;pitch=e,document.getElementById("pitch").innerHTML=notes[e],midiOffset=12*octave+pitch+24,drawMap()}function setOctave(e){if(-2>e||e>8)throw"Octave out of range (-2 to 8):"+e;octave=e,document.getElementById("octave").innerHTML=e,midiOffset=12*octave+pitch+24,drawMap()}function setScale(e){if(void 0==e)throw"setScale expects array";scale=e;var t=document.getElementById("scale");t.value=e.join(" "),drawMap()}function reGenerate(){var e=document.getElementById("scale").value,t=[],o=[];if(t=e.match(/(\d+)/g)){for(var r=0;r<t.length;r++)if(o[r]=Number(t[r]),o[r]<1||o[r]>23)return void window.alert("Intervals must be between 1 and 23: "+n)}else{if(t=e.match(/[WH]/g)||e.match(/[TS]/g),!t)return void window.alert("Intervals must be in format 2,2,1 or TTS or WWH");for(var r=0;r<t.length;r++)"H"==t[r]||"S"==t[r]?o[r]=1:("W"==t[r]||"T"==t[r])&&(o[r]=2)}document.getElementById("scale").value=t.join(" "),scale=o,drawMap()}function drawMap(){var e=midiOffset;midiNotes[0]=e;for(var t=1;nRows>t;)for(var n=0;n<scale.length&&(e+=scale[n],e>127&&(e=128),midiNotes[t++]=e,t!=nRows);n++);for(var o="",t=0;nRows>t&&128!=midiNotes[t];t++)o=o+"<td>"+t+"</td>";o+="</tr><tr>";for(var t=0;nRows>t&&128!=midiNotes[t];t++)o=o+"<td>"+midiNoteName(midiNotes[t])+"</td>";o+="</tr><tr>",o+="</tr>",document.getElementById("map").innerHTML=o,writeMetadata(),outputNoteNames()}function midiNoteName(e){return 128>e?notes[e%12]+(Math.floor(e/12)-2).toString():""}function lilyNotename(e){var t=["c","cs","d","ef","e","f","fs","g","af","a","bf","b","c"],n=",,,,,'''''",o="";return e>127?" ":(e>71?o=n.substring(5,Math.floor(e/12)):60>e&&(o=n.substring(0,5-Math.floor(e/12))),t[e%12]+o)}function playbuttonsDisabled(e){elements=document.getElementsByClassName("play");for(var t=0;t<elements.length;t++)elements[t].disabled=e}function initAudio(){playStop();for(var e=0;e<audioContexts.length;e++)audioContexts[e].close();audioContexts=[],audioInitialized=!1,playbuttonsDisabled(!0),startAudio()}function startAudio(e){audioInitialized=!1,playbuttonsDisabled(!0),audioCtx=new(window.AudioContext||window.webkitAudioContext),audioContexts.push(audioCtx);var t=new Soundfont(audioCtx);piano=t.instrument(void 0==e?"acoustic_grand_piano":e),piano.onready(function(){audioInitialized=!0,playbuttonsDisabled(!1)})}function playStop(){for(var e=0;e<audioSources.length;e++)audioSources[e]&&audioSources[e].stop(0);audioSources=[]}function extendNotes(e){extension=Number(e),.5>extension?extension=.5:extension>8&&(extension=8)}function playRoll(e){notesPerBeat=1>e?1:e>16?16:e;var t=Number(document.getElementById("bpm").value);if(isNaN(t)||30>t||t>180)return void window.alert("Tempo must be between 30 and 180 bpm");if(bpm=t,audioInitialized)for(var n=audioCtx.currentTime+.1,o=60/(bpm*notesPerBeat),r=selected?selleft:0,l=selected?selright:seqLen-1,a=r;l>=a;a++){for(j=0;j<nRows;j++)roll[a][nRows-j-1]>(selected?1:0)&&audioSources.push(piano.play(midiNoteName(midiNotes[j]),n,o*extension));n+=o}}function checkCGI(e,t){var n=new XMLHttpRequest;n.onreadystatechange=function(){4==n.readyState&&200==n.status?document.getElementById(t).style.display="inline":document.getElementById(t).style.display="none"},n.open("GET",e,!0),n.send(null)}function initExport(){var e=document.getElementById("midiform").action,t=document.getElementById("lilyform").action,n=document.getElementById("provform").action;""!=t&&checkCGI(t,"lilysubmit"),""!=e&&checkCGI(e,"midisubmit"),""!=n&&checkCGI(e,"provsubmit"),writeMetadata(),outputNoteNames()}function writeMetadata(){var e=seq.slice(0,seqLen>10?10:seqLen).join(","),t=modSeq.slice(0,seqLen>10?10:seqLen).join(",");mScale=scale.join(","),mSelection_bl=selected?selleft+","+midiNoteName(midiNotes[nRows-seltop-1]):"0,"+midiNoteName(midiNotes[0]),mSelection_tr=selected?selright+","+midiNoteName(midiNotes[nRows-selbot-1]):seqLen-1+","+midiNoteName(midiNotes[nRows-1]),mSelection_n=selected?selected:seqLen;for(var n="",o=0;o<parameters.length;o++)n&&(n+=", "),n+=parameters[o][0]+"="+parameters[o][1];""!=algorithm&&seqLen&&nRows&&(mDate=Date(),mGuid=createGuid(),mExplanation=algorithm,n&&(mExplanation+=" ("+n+")"),modulus&&(mExplanation+=" mod "+modulus),mExplanation+=" on "+seqLen+" x "+nRows+" number roll with 0 mapped to "+notes[pitch]+octave+" and scale generated on intervals "+mScale+", playing with "+mSelection_n+" notes selected in ["+mSelection_bl+"] to ["+mSelection_tr+"] at tempo "+bpm+"bpm, created on "+mDate+". The first numbers in the original sequence are "+e+" and in the reduced sequence are "+t+".",document.getElementById("metaTitle").value=algorithm,document.getElementById("metaDescription").value=mExplanation,document.getElementById("metaDate").value=mDate,document.getElementById("metaIdentifier").value=mGuid,document.getElementById("metaSequence").innerHTML=e,document.getElementById("metaPitch").innerHTML=notes[pitch],document.getElementById("metaOctave").innerHTML=octave,document.getElementById("metaScale").innerHTML=mScale,document.getElementById("metaTempo").innerHTML=bpm,document.getElementById("metaRows").innerHTML=nRows,document.getElementById("metaColumns").innerHTML=seqLen,document.getElementById("metaSelection").innerHTML=mSelection_n+" ["+mSelection_bl+"],["+mSelection_tr+"]")}function readMetadata(){mTitle=document.getElementById("metaTitle").value,mCreator=document.getElementById("metaCreator").value,mExplanation=document.getElementById("metaDescription").value,mId=document.getElementById("metaIdentifier").value}function outputAll(){outputNoteNames(),outputMidiCsv(),outputProv(),outputLilypond()}function outputImage(){var e,t=document.getElementById("jumbo").clientWidth;if(!(50>t)){e=seqLen*cellWidth>t?new Image(t-30):new Image,e.src=canvas.toDataURL("image/png");var n=document.getElementById("rollimage");n.childNodes.length&&n.firstChild instanceof HTMLImageElement?n.replaceChild(e,n.firstChild):n.appendChild(e)}}function outputNoteNames(){for(var e=selected?selleft:0,t=selected?selright:seqLen-1,n="",o=[],r=e;t>=r;r++){for(o=[],j=0;j<nRows;j++)roll[r][nRows-j-1]>(selected?1:0)&&o.push(midiNoteName(midiNotes[j]));n+=o.length>1?" <"+o.join(" ")+">":1==o.length?o[0]:"-",n+=" "}readMetadata(),document.getElementById("notestext").value=n}function outputLilypond(){for(var e="",t="",n=0;nRows>n&&!(midiNotes[n]>=72);)n++;for(var o=selected?selleft:0,r=selected?selright:seqLen-1,l=[],a=0,i=0,s="",d=o;r>=d;){s="";for(var m=0;notesPerBeat>m&&!(d+m>r);m++){for(l=[],j=n;j<nRows;j++)roll[d+m][nRows-j-1]>(selected?1:0)&&l.push(lilyNotename(midiNotes[j]));i+=l.length,s+=l.length>1?" <"+l.join(" ")+">":1==l.length?l[0]:"r",s+=notesPerBeat,s+=8==notesPerBeat&&m%2==1?"  ":" "}e+=s+"| ",s="";for(var m=0;notesPerBeat>m&&!(d+m>r);m++){for(l=[],j=0;j<n;j++)roll[d+m][nRows-j-1]>(selected?1:0)&&l.push(lilyNotename(midiNotes[j]));a+=l.length,s+=l.length>1?" <"+l.join(" ")+">":1==l.length?l[0]:"r",s+=notesPerBeat,s+=8==notesPerBeat&&m%2==1?"  ":" "}t+=s+"| ",d+=notesPerBeat}readMetadata();for(var c=["% "+mDate,"% id "+mId,'\\version "2.16.2"','\\language "english"',"\\header {",'  title = "'+mTitle+'"','  composer = "'+mCreator+'"',"}","upper = {","  \\clef treble","  \\key c \\major","  \\time 4/4","  "+compressRests(e),"}","lower = {","  \\clef bass","  \\key c \\major","  \\time 4/4","  "+compressRests(t),"}","\\score {","  \\new PianoStaff <<",'    \\set PianoStaff.instrumentName = #"Piano  "',i?'    \\new Staff = "upper" \\upper':"",a?'    \\new Staff = "lower" \\lower':"","  >>","  \\layout { }","  \\midi { \\tempo "+notesPerBeat+" = "+bpm+" }","}"],u=mExplanation.split(" ");u.length;)c.push("% "+u.splice(0,10).join(" "));c.push(""),c.push("% NumbersIntoNotes ID "+mGuid),document.getElementById("lilytext").value=c.join("\n")}function compressRests(e){return e=e.replace(/r8 r8  /g,"r4 "),e=e.replace(/r4 r4 \|/g,"r2 |"),e=e.replace(/r4 r4 /g,"r2 "),e=e.replace(/r2 r2 /g,"r1 ")}function outputMidiCsv(){var e=0,t=Number(document.getElementById("bpm").value),n=t*notesPerBeat*24/60,o=[],r=selected?selleft:0,l=selected?selright:seqLen-1,a=[];readMetadata();var i="s "+seq.slice(0,seqLen>5?5:seqLen).join(",")+" l "+seqLen+" n "+nRows+" p "+pitch+" o "+octave+" i "+scale.join(",");o=["0, 0, Header, 1, 2, 480","1, 0, Start_track",'1, 0, Title_t, "'+mTitle+'"','1, 0, Text_t, "'+i+'"','1, 0, Copyright_t, "'+mGuid+'"',"1, 0, Time_signature, 4, 2, 24, 8","1, 0, Tempo, 500000","1, 0, End_track","2, 0, Start_track",'2, 0, Instrument_name_t, "Acoustic Grand Piano"',"2, 0, Program_c, 1, 1"];for(var s=r;l>=s;s++){for(a=[],j=0;j<nRows;j++)roll[s][nRows-j-1]>(selected?1:0)&&midiNotes[modSeq[s]]<128&&a.push(midiNotes[j]);for(var d=0;d<a.length;d++)o.push("2, "+e+", Note_on_c, 1, "+midiNotes[modSeq[s]]+", 81 ");for(var d=0;d<a.length;d++)o.push("2, "+(e+n)+", Note_on_c, 1, "+midiNotes[modSeq[s]]+", 0 ");e+=n}o.push("2, "+e+", End_track"),o.push("0, 0, End_of_file");var m="";for(s=0;s<o.length;s++)m+=o[s]+"\n";document.getElementById("miditext").value=m}function outputProv(){for(var e="",t=0;t<parameters.length;t++)e&&(e+=", "),e+="nin:"+parameters[t][0]+'="'+parameters[t][1]+'"';var n=["// "+mTitle,"// "+mDate,"document","// Stage 1 - Generate Integers","prefix prov <http://www.w3.org/ns/prov#>","prefix nin <http://www.nin.oerc.ox.ac.uk/var#>","entity(nin:IntegerSequence)","activity(nin:"+algorithm+(e?", ["+e+"])":")"),"wasGeneratedBy(nin:IntegerSequence, nin:"+algorithm+", -)","// Stage 2 - Clock Arithmetic","entity(nin:ModSequence)",'activity(nin:ReduceByModulus, [nin:mod="'+modulus+'"])',"wasGeneratedBy(nin:ModSequence, nin:ReduceByModulus, -)","used(nin:ReduceByModulus, nin:IntegerSequence, -)","// Stage 3 - Play","entity(nin:Selection)",'activity(nin:Select, [prov:type="edit", nin:count="'+mSelection_n+'", nin:bl="'+mSelection_bl+'", nin:tr="'+mSelection_tr+'"])',"wasGeneratedBy(nin:Selection, nin:Select, -)","used(nin:Select, nin:ModSequence, -)","entity(nin:Composer)",'agent(nin:Composer, [prov:type="prov:Person"])',"wasAssociatedWith(nin:Selection, nin:Composer, -)","entity(nin:Notes)",'activity(nin:Map, [nin:pitch="'+pitch+'", nin:octave="'+octave+'", nin:scale="'+mScale+'"])',"wasGeneratedBy(nin:Notes, nin:Map, -)","used(nin:Map, nin:Selection, -)","// Stage 4 - Export","entity(nin:midi/"+mGuid+', [prov:type="document"])',"activity(nin:Export)","wasGeneratedBy(nin:midi/"+mGuid+", nin:Export, -)","used(nin:Export, nin:Notes, -)","endDocument","// NumbersIntoNotes ID "+mGuid];document.getElementById("provtext").value=n.join("\n")}function doSubmit(){document.getElementById("exportform").submit()}function playNote(e){piano.play(e,audioCtx.currentTime,.5)}function createGuid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)})}function initPage(){document.getElementById("sequence").innerHTML="",document.getElementById("modsequence").value=""}var maxSeqLen=256,seqLen=0,algorithm="",parameters=[],seq=[];Big.E_POS=50;var modSeq=[],modulus=0,nRows=0,cellWidth=8,cellHeight=8,roll=[],memory=[],rect={},mousedown=!1,touchscreen=!1,rollempty=!0,selStack=[],selected=0,selleft=0,selright=0,seltop=0,selbot=0,canvas=document.getElementById("pianoroll"),context=canvas.getContext("2d");context.strokeStyle="LightGray",context.fillStyle="CadetBlue";var seloffset=0,midiNotes=[],notes=["C","C#","D","Eb","E","F","F#","G","Ab","A","Bb","B","C"],pitch=0,octave,midiOffset,scale=[];setPitch(0),setOctave(1),setScale([2,2,1,2,2,2,1]);var audioCtx=null,piano=null,notesPerBeat=8,bpm=60,inst="acoustic_grand_piano",audioInitialized=!1,extension=1,audioContexts=[],audioSources=[],mTitle="",mCreator="",mExplanation="",mId="",mDate="",mGuid="",mScale="",mSelection_n=0,mSelection_bl="",mSelection_tr="";